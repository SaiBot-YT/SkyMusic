<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1">
    <title>Sky Music</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
</head>
<link rel="stylesheet" href="style.css" type="text/css">

<body>
    <div id="savedSongsDiv" class="floatingDiv">
        <h2>Here are all your saved songs!</h2>
    </div>
    <div class="menuDiv">
        <button class="skyButton" onclick="toggleSavedSongs()">Manage Recordings</button>
        <button class="skyButton" id="toggleRecordBtn" onclick="toggleRecord()"> Start/Stop recording</button>
    </div>
    <div class="videoWrapper video">
        <div class="vsc-controller" data-vscid="jvm0gu2z7"></div>
        <video preload="auto" playsinline="" muted="" autoplay="" loop="" data-vscid="jvm0gu2z7">
            <source src="./AnimatedBG/skygame-banner.webm" type="video/webm;codecs=&quot;vp8, vorbis&quot;">
            <source src="./AnimatedBG/skygame-banner.ogv" type="video/ogv;codecs=&quot;ogv, ogg, vorbis &quot;">
            <source src="./AnimatedBG/skygame-banner.mp4" type="video/mp4;codecs=&quot;avc1.42E01E, mp4a.40.2&quot;">
        </video>
    </div>
    <div id=touch>
        <div class="Row1" id="row1"></div>
        <div class="Row2" id="row2"></div>
        <div class="Row3" id="row3"></div>
    </div>
    </div>
</body>

</html>
<script type="text/javascript">
    var i;
    var keyclicked;
    var element;

    //Changes the image when button clicked.
    function reply_click(clicked_id) {
        i = clicked_id;
        a = i.replace(/Key/, '')
        console.log('Playing Key' + a)
        element = document.getElementById(i);
        element.style = 'background-image : url(./KeyImages/KeyClicked-' + a + '.png)';
        timer(element, a);
    }

    //Resets the buttons image after its clicked.
    function timer(elem, aa) {
        setTimeout(function() {
            elem.style = 'background-image : url(./KeyImages/Key-' + aa + '.png)';
        }, 200);
    }

    //Loads the buttons with sounds
    const db_url = 'https://dl.dropboxusercontent.com/s/';
    const urls = ["xim7yvy80ou80bi/0.mp3?dl=0", "adh4qa72jiw7q4b/1.mp3?dl=0", "546fmppbpvr80rh/2.mp3?dl=0", "aaph2izhy89oljc/3.mp3?dl=0", "oia9cq7mmk7lsa0/4.mp3?dl=0", "4285w5uzn5um6ay/5.mp3?dl=0", "2o1nszo0ry2ttoi/6.mp3?dl=0", "cnhjr7ljph30ycz/7.mp3?dl=0", "lqo9zv4bm6h13x4/8.mp3?dl=0", "d0brnsgqorwo67i/9.mp3?dl=0", "jq9dl35enpn4hgc/10.mp3?dl=0", "a07cku2ns81oiw2/11.mp3?dl=0", "c1gj4cn9ksctvhz/12.mp3?dl=0", "w1hhusqautlwz5w/13.mp3?dl=0", "u94o8hu4i05b0to/14.mp3?dl=0"];
    const a_ctx = new(window.AudioContext || window.webkitAudioContext)();

    let usesTouch = false;
    preload(urls)
        .then(audioBuffers => {
            audioBuffers.forEach((buf, i) => {
                //Creates button and sets the buttons properties .
                const btn = document.createElement('button');
                btn.id = "Key" + i++
                btn.addEventListener("click", function() {
                    if (!usesTouch) buttonPressEvent(this)
                })
                btn.addEventListener("touchstart", function() {
                    usesTouch = true;
                    buttonPressEvent(this)
                })

                 usesTouch = false;

                function buttonPressEvent(btn) {
                  const source = a_ctx.createBufferSource();
                  source.buffer = buf;
                  source.connect(a_ctx.destination);
                  source.start(0);
                  reply_click(btn.id)
                  recordSong(btn.id)
                }
                //Creates the buttons and adds them to the right div.
                document.body.appendChild(btn)
                $("#Key0").appendTo("#row1"), $("#Key0").css({
                    "background-image": "url(./KeyImages/Key-0.png)"
                })
                $("#Key1").appendTo("#row1"), $("#Key1").css({
                    "background-image": "url(./KeyImages/Key-1.png)"
                })
                $("#Key2").appendTo("#row1"), $("#Key2").css({
                    "background-image": "url(./KeyImages/Key-2.png)"
                })
                $("#Key3").appendTo("#row1"), $("#Key3").css({
                    "background-image": "url(./KeyImages/Key-3.png)"
                })
                $("#Key4").appendTo("#row1"), $("#Key4").css({
                    "background-image": "url(./KeyImages/Key-4.png)"
                })

                $("#Key5").appendTo("#row2"), $("#Key5").css({
                    "background-image": "url(./KeyImages/Key-5.png)"
                })
                $("#Key6").appendTo("#row2"), $("#Key6").css({
                    "background-image": "url(./KeyImages/Key-6.png)"
                })
                $("#Key7").appendTo("#row2"), $("#Key7").css({
                    "background-image": "url(./KeyImages/Key-7.png)"
                })
                $("#Key8").appendTo("#row2"), $("#Key8").css({
                    "background-image": "url(./KeyImages/Key-8.png)"
                })
                $("#Key9").appendTo("#row2"), $("#Key9").css({
                    "background-image": "url(./KeyImages/Key-9.png)"
                })

                $("#Key10").appendTo("#row3"), $("#Key10").css({
                    "background-image": "url(./KeyImages/Key-10.png)"
                })
                $("#Key11").appendTo("#row3"), $("#Key11").css({
                    "background-image": "url(./KeyImages/Key-11.png)"
                })
                $("#Key12").appendTo("#row3"), $("#Key12").css({
                    "background-image": "url(./KeyImages/Key-12.png)"
                })
                $("#Key13").appendTo("#row3"), $("#Key13").css({
                    "background-image": "url(./KeyImages/Key-13.png)"
                })
                $("#Key14").appendTo("#row3"), $("#Key14").css({
                    "background-image": "url(./KeyImages/Key-14.png)"
                })
            });
        });

    function preload(urls) {
        const requests = urls.map(url => fetch(db_url + url)
            .then(r => r.arrayBuffer()) // this time we request as ArrayBuffer
            .then(b => {
              return new Promise((resolve, reject) => {
                  a_ctx.decodeAudioData(b, resolve, reject)
              });
            })
        );
        return Promise.all(requests);
    }

    let isRecordToggled = false;
    var startTime;
    var animationInterval;
    //turns on the recording, and in case there was a previous recording, sends it to be saved (this function has to be added)
    function toggleRecord() {
        if (isRecordToggled) {
            if (songArray.length != 0){
                var promtText = prompt("Please enter the song name:", "Jingle bells");
                if (promtText == null || promtText == "") {
                    console.log("User ignored the save")
                } else {
                    if(document.getElementById("Song-"+promtText) == null){
                        saveSong(promtText,songArray,false)
                    }else{
                        var promtText2 = prompt("Warning! a song with that name already exists", "Rename Me!");
                        if (promtText2 == null || promtText2 == "") {
                            console.log("User ignored the save")
                            } else {
                                saveSong(promtText2,songArray,false)
                            }
                    }
                }
            }
            songArray = []
            toggleRecordBtn.style.backgroundColor = "#5a5a5a"
        } else {
            toggleRecordBtn.style.backgroundColor = "#817f7f"
        }
        isRecordToggled = !isRecordToggled
        startTime = new Date().getTime()
    }
    var savedSongsDiv = document.getElementById("savedSongsDiv")
    document.getElementById("touch").addEventListener("click",function(){
        savedSongsDiv.style.display = "none"
    })
    function toggleSavedSongs(){
        if(savedSongsDiv.style.display != "block"){
            savedSongsDiv.style.display = "block"
        }else{
            savedSongsDiv.style.display = "none"
        }
    }



    preLoadSongs = localStorage.getItem("savedSongs")
    if(preLoadSongs != null){
        preLoadSongs = JSON.parse(preLoadSongs)
        for(var i=0;i<preLoadSongs.length;i++){
            saveSong(preLoadSongs[i].name,preLoadSongs[i].songNotes,true)
        }
    }
    function saveSong(songName,song,isPreloading){
        //to add something that stores the songs in memory, could use localstorage but that's only on one device so maybe, account system?
            var songObj = {
                name: songName,
                songNotes : song
            }
            if(!isPreloading){ //doesnt save if it is preloading
                var songStorage = localStorage.getItem("savedSongs")
            if(songStorage != null){
                songStorage = JSON.parse(songStorage)
                songStorage.push(songObj)
                localStorage.setItem("savedSongs",JSON.stringify(songStorage))
            }else{
                songStorage = [songObj]
                localStorage.setItem("savedSongs",JSON.stringify(songStorage))
            }
            }
        var songContainer = document.createElement("div")
        var songButton = document.createElement("button")
            songButton.setAttribute("songName",songName)
            songButton.addEventListener("click",function(){
                var storedSongName = this.getAttribute("songName")
                songText = document.getElementById("Song-"+storedSongName)
                playSong(JSON.parse(songText.innerHTML))

            })
            songButton.innerHTML = songName
            songButton.className = "skyButton"
            songButton.style.width = "65%"
        var songText = document.createElement("div")
            songText.style.display = "none"
            songText.id = "Song-"+songName
            songText.innerHTML = JSON.stringify(song)
            songContainer.appendChild(songButton)
            songContainer.appendChild(songText)
            console.log("song added!")
            savedSongsDiv.appendChild(songContainer)
        var smallContainer = document.createElement("div")
            smallContainer.style = "width: 22%"
        var deleteButton = document.createElement("button")
            deleteButton.innerHTML = "❌"
            deleteButton.className = "skyButton"
            deleteButton.style.width = "10%"
            deleteButton.setAttribute("songName",songName)
            deleteButton.addEventListener("click",function(){
                if(confirm("Delete song: "+this.getAttribute("songName")+"?")){
                    this.parentNode.parentNode.removeChild(this.parentNode)
                    var savedSongs = localStorage.getItem("savedSongs")
                    if(savedSongs != null){
                        savedSongs = JSON.parse(savedSongs)
                        for(var i=0;i<savedSongs.length;i++){
                            if(savedSongs[i].name == this.getAttribute("songName")){
                                savedSongs.splice(i,1)
                                break;
                            }
                        }
                        localStorage.setItem("savedSongs",JSON.stringify(savedSongs))
                    }
                }
            })
            songContainer.appendChild(deleteButton)
    }

    async function playSong(song){
        var delayTime = 0;
        var previousTime = 0;
        usesTouch = false;
        for(var i=0;i<song.length;i++){
            delayTime = song[i].time - previousTime
            previousTime = song[i].time
            await delay(delayTime);
            document.getElementById(song[i].key).click()
        }
    }
    let songArray = []
    //Each time a button is pressed, if the record is toggled, it adds a timestamp and what button is pressed
    function recordSong(pressedKey) {
        if (isRecordToggled) {
            pressTime = new Date().getTime()
            var keyPressObject = {
                time: pressTime - startTime,
                key: pressedKey
            }
            songArray.push(keyPressObject)
        }
    }

    //Plays song when P is pressed.
    const delay = ms => new Promise(res => setTimeout(res, ms));
    $(document).keydown(function(keyPressed) {
        if (keyPressed.keyCode == 80) {
            MarriedLife()
        }
    });

    //Preset Song 1
    var MarriedLife = async() => {
        usesTouch = false;
        //Notes
        var C1 = document.getElementById("Key0")
        var D1 = document.getElementById("Key1")
        var E1 = document.getElementById("Key2")
        var F1 = document.getElementById("Key3")
        var G1 = document.getElementById("Key4")
        var A2 = document.getElementById("Key5")
        var B2 = document.getElementById("Key6")
        var C2 = document.getElementById("Key7")
        var D2 = document.getElementById("Key8")
        var E2 = document.getElementById("Key9")
        var F3 = document.getElementById("Key10")
        var G3 = document.getElementById("Key11")
        var A3 = document.getElementById("Key12")
        var B3 = document.getElementById("Key13")
        var C3 = document.getElementById("Key14")

        F1.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        C1.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        D1.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        E1.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        F1.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500)
        C1.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        D1.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        E1.click()
        await delay(500);
        //Faster part
        A2.click() + C2.click()
        await delay(250);
        F3.click()
        await delay(250);
        A2.click() + C2.click() + A3.click()
        await delay(250);
        F3.click()
        await delay(250);
        //Slower part
        F1.click() + E2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        C1.click()
        await delay(500);
        //Faster part
        A2.click() + C2.click()
        await delay(250);
        F3.click()
        await delay(250);
        A2.click() + C2.click() + A3.click()
        await delay(250);
        F3.click()
        await delay(250);
        //Slower part
        D1.click() + D2.click()
        await delay(500);
        //faster part
        A2.click() + C2.click()
        await delay(250);
        D2.click()
        await delay(250);
        A2.click() + C2.click() + F1.click()
        await delay(250);
        D2.click()
        await delay(250);
        C1.onmousedown + C2.click()
            //slower part
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
            //faster part
        await delay(250);
        D2.click()
        await delay(250);
        D1.click() + A3.click()
            //slower part
        await delay(500);
        D1.click() + F1.click() + G3.click()
        await delay(500);
        D1.click() + F1.click()
            //faster part
        await delay(250);
        F3.click()
        await delay(250);
        D1.click() + A3.click()
            //slower part
        await delay(500);
        D1.click() + F1.click() + G3.click()
        await delay(500);
        D1.click() + F1.click() + F3.click()
        await delay(500);
        D1.click() + D2.click()
        await delay(500);
        D1.click() + D2.click()
        await delay(500);
        D1.click()
        await delay(500);
        //faster part
        D1.click() + F1.click()
        await delay(250);
        F3.click()
        await delay(250);
        G3.click()
        await delay(250);
        F3.click()
        await delay(250);
        C1.click() + E2.click()
            //slower part
        await delay(500);
        E1.click() + G1.click()
        await delay(500);
        E1.click() + G1.click()
        await delay(500);
        C1.click()
            //faster part
        await delay(250);
        E1.click() + G1.click()
        await delay(250);
        E2.click()
        await delay(250);
        E1.click() + G1.click() + G3.click()
        await delay(250);
        E2.click()
        await delay(250);
        C1.click() + C2.click()
            //slower part
        await delay(500);
        //faster part
        E1.click() + G1.click()
        await delay(500);
        D2.click()
        await delay(500);
        E1.click() + G1.click() + E2.click()
        await delay(500);
        C2.click()
        await delay(500);
        C1.onmousedown + G1.onmousedown
            //slower part
        await delay(500);
        E1.click() + G1.click()
        await delay(500);
        E1.click() + G1.click()
        await delay(500);
        C1.click() + F1.click()
        await delay(500);
        C2.click()
        await delay(500);
        A2.click()
        await delay(500);
        B2.click()
        await delay(500);
        C1.onmousedown + G1.click() + C2.click()
        await delay(500);
        D2.click()
        await delay(500);
        E2.click()
        await delay(500);
        C1.click() + G1.click()
        await delay(500);
        C2.click()
        await delay(500);
        D2.click()
        await delay(500);
        C1.click() + G1.click() + E2.click()
            //----------ERROR ABOVE ^^
        await delay(250);
        //fast part
        F3.click()
        await delay(250);
        A3.click()
        await delay(250);
        F3.click()
        await delay(250);
        F1.click() + E2.click()
            //slower part
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        C1.click()
        await delay(500);
        //faster part
        A2.click() + C2.click()
        await delay(250);
        F3.click()
        await delay(250);
        A2.click() + C2.click() + A3.click()
        await delay(250);
        F3.click()
        await delay(250);
        D1.click() + D2.click()
            //slower part 
        await delay(500);
        //faster part
        A2.click() + C2.click()
        await delay(250);
        F3.click()
        await delay(250);
        A2.click() + C2.click() + A3.click()
        await delay(250);
        C3.click()
        await delay(250);
        C1.click() + B3.click()
            //slower part
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A2.click() + C2.click()
        await delay(500);
        A3.click()
        await delay(500);
        D1.click() + C3.click()
        await delay(500);
        D1.click() + F1.click() + B3.click()
        await delay(500);
        D1.click() + F1.click()
        await delay(500);
        F3.click() + D1.click()
        await delay(500);
        D1.click() + F1.click() + G3.click()
        await delay(500);
        D1.click() + F1.click()
        await delay(500);
        F3.click()
        await delay(500);
        D1.click() + D2.click()
        await delay(500);
        D1.click() + F1.click()
        await delay(500);
        D1.onmousedown + F1.click()
        await delay(500);
        D1.click()
            //faster part
        await delay(250);
        D1.click() + F1.click()
        await delay(250);
        F3.click()
        await delay(250);
        A3.click()
        await delay(250);
        F3.click()
        await delay(250);
        C1.click() + E2.click()
            //slower part
        await delay(500);
        E1.onmousedown + G1.onmousedown
        await delay(500);
        E1.click() + G1.click()
    };
</script>