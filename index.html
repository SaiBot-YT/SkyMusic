<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1">
    <title>Sky Music</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
</head>
<link rel="stylesheet" href="style.css" type="text/css">

<body>
    <div id="savedSongsDivWrapper" class="floatingDiv">
        <h3>Here are all your saved songs!</h3>
        <div id="savedSongsDiv" class="topSavedSongsDiv"></div>
        <div class = "bottomSavedSongsDiv">
            <button class="skyButton" onclick="importSongs()">Import songs</button>
            <input type=file style="display:none;" id="filePicker">
            <button class="skyButton" onclick="downloadSongs()">Download songs</button>
        </div>
    </div>
    <div class="menuDiv">
        <button class="skyButton" onclick="toggleSavedSongs()">Manage Recordings</button>
        <button class="skyButton" id="toggleRecordBtn" onclick="toggleRecord()"> Start/Stop recording</button>
    </div>
    <div class="videoWrapper video">
        <div class="vsc-controller" data-vscid="jvm0gu2z7"></div>
        <video preload="auto" playsinline="" muted="" autoplay="" loop="" data-vscid="jvm0gu2z7">
            <source src="./AnimatedBG/skygame-banner.webm" type="video/webm;codecs=&quot;vp8, vorbis&quot;">
            <source src="./AnimatedBG/skygame-banner.ogv" type="video/ogv;codecs=&quot;ogv, ogg, vorbis &quot;">
            <source src="./AnimatedBG/skygame-banner.mp4" type="video/mp4;codecs=&quot;avc1.42E01E, mp4a.40.2&quot;">
        </video>
    </div>
    <div id=touch>
        <div class="Row1" id="row1"></div>
        <div class="Row2" id="row2"></div>
        <div class="Row3" id="row3"></div>
    </div>
    </div>
</body>

</html>
<script type="text/javascript">
    var i;
    var keyclicked;
    var element;
    //Changes the brightness when button clicked.
    function reply_click(clicked_id) {
        i = clicked_id;
        a = i.replace(/Key/, '')
        console.log('Playing Key' + a)
        element = document.getElementById(i);
        element.style.filter = "brightness(130%)"
        timer(element, a);
    }
//--------------------------------------------------------------------------------------------------------//

    function timer(elem,aa){
         setTimeout(function() {
             elem.style.filter='brightness(100%)';
        } ,200);
    }
//--------------------------------------------------------------------------------------------------------//
//--------------------------------------------------------------------------------------------------------//
//FILE IMPORT/EXPORT
    var filePicker = document.getElementById("filePicker")
    function importSongs(){
        filePicker.addEventListener("change",function(){ //once file is picked it reads the content
            var fr=new FileReader(); 
            fr.onload=function(){ 
                inputSongs = JSON.parse(fr.result)
                for(var i = 0; i<inputSongs.length;i++){
                    if(document.getElementById("Song-"+inputSongs[i].name) == null){ //if there is an element with this id, it means that the song with that name already exists
                        saveSong(inputSongs[i].name,inputSongs[i].songNotes,false)
                    }else{
                        console.log("there is already a song with the name: "+inputSongs[i].name)
                    }
                }
            }       
            fr.readAsText(this.files[0]); 
        })
        filePicker.click()
    }
//--------------------------------------------------------------------------------------------------------//
    function downloadSongs(){
        var songs = localStorage.getItem("savedSongs") //gets the songs saved in localStorage and downloads them as JSON
        if(songs != null){ //if there were some songs saved
            songs = JSON.parse(songs)
            console.log(songs)
            if(songs.length != 0){//if there were some songs saved
                downloadJSON(songs,"mySongs.json")
            }
        }
    }
//--------------------------------------------------------------------------------------------------------//
    function downloadJSON(inArray,fileName) {
        var json = JSON.stringify(inArray);
 
        //Convert JSON string to BLOB.
        json = [json];
        var blob1 = new Blob(json, { type: "text/plain;charset=utf-8" });
 
        //Check the Browser.
        //Honestly idk lol, i copied this and it works -Specy
        var isIE = false || !!document.documentMode;
        if (isIE) {
            window.navigator.msSaveBlob(blob1, fileName);
        } else {
            var url = window.URL || window.webkitURL;
            link = url.createObjectURL(blob1);
            var a = document.createElement("a");
            a.download = fileName;
            a.href = link;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    }
//--------------------------------------------------------------------------------------------------------//
    //Loads the buttons with sounds
    const db_url = 'https://dl.dropboxusercontent.com/s/';
    const urls = ["xim7yvy80ou80bi/0.mp3?dl=0", "adh4qa72jiw7q4b/1.mp3?dl=0", "546fmppbpvr80rh/2.mp3?dl=0", "aaph2izhy89oljc/3.mp3?dl=0", "oia9cq7mmk7lsa0/4.mp3?dl=0", "4285w5uzn5um6ay/5.mp3?dl=0", "2o1nszo0ry2ttoi/6.mp3?dl=0", "cnhjr7ljph30ycz/7.mp3?dl=0", "lqo9zv4bm6h13x4/8.mp3?dl=0", "d0brnsgqorwo67i/9.mp3?dl=0", "jq9dl35enpn4hgc/10.mp3?dl=0", "a07cku2ns81oiw2/11.mp3?dl=0", "c1gj4cn9ksctvhz/12.mp3?dl=0", "w1hhusqautlwz5w/13.mp3?dl=0", "u94o8hu4i05b0to/14.mp3?dl=0"];
    const a_ctx = new(window.AudioContext || window.webkitAudioContext)();

    let usesTouch = false;
    preload(urls)
        .then(audioBuffers => {
            audioBuffers.forEach((buf, i) => {
                //Creates button and sets the buttons properties .
                const btn = document.createElement('button');
                btn.id = "Key" + i++
                btn.addEventListener("click", function() {
                    if (!usesTouch) buttonPressEvent(this)
                })
                btn.addEventListener("touchstart", function() {
                    usesTouch = true;
                    buttonPressEvent(this)
                })

                 usesTouch = false;

                function buttonPressEvent(btn) {
                  const source = a_ctx.createBufferSource();
                  source.buffer = buf;
                  source.connect(a_ctx.destination);
                  source.start(0);
                  reply_click(btn.id)
                  recordSong(btn.id)
                }
                //Creates the buttons and adds them to the right div.
                document.body.appendChild(btn)
                $("#Key0").appendTo("#row1"), $("#Key0").css({
                    "background-image": "url(./KeyImages/Key-0.png)"
                })
                $("#Key1").appendTo("#row1"), $("#Key1").css({
                    "background-image": "url(./KeyImages/Key-1.png)"
                })
                $("#Key2").appendTo("#row1"), $("#Key2").css({
                    "background-image": "url(./KeyImages/Key-2.png)"
                })
                $("#Key3").appendTo("#row1"), $("#Key3").css({
                    "background-image": "url(./KeyImages/Key-3.png)"
                })
                $("#Key4").appendTo("#row1"), $("#Key4").css({
                    "background-image": "url(./KeyImages/Key-4.png)"
                })

                $("#Key5").appendTo("#row2"), $("#Key5").css({
                    "background-image": "url(./KeyImages/Key-5.png)"
                })
                $("#Key6").appendTo("#row2"), $("#Key6").css({
                    "background-image": "url(./KeyImages/Key-6.png)"
                })
                $("#Key7").appendTo("#row2"), $("#Key7").css({
                    "background-image": "url(./KeyImages/Key-7.png)"
                })
                $("#Key8").appendTo("#row2"), $("#Key8").css({
                    "background-image": "url(./KeyImages/Key-8.png)"
                })
                $("#Key9").appendTo("#row2"), $("#Key9").css({
                    "background-image": "url(./KeyImages/Key-9.png)"
                })

                $("#Key10").appendTo("#row3"), $("#Key10").css({
                    "background-image": "url(./KeyImages/Key-10.png)"
                })
                $("#Key11").appendTo("#row3"), $("#Key11").css({
                    "background-image": "url(./KeyImages/Key-11.png)"
                })
                $("#Key12").appendTo("#row3"), $("#Key12").css({
                    "background-image": "url(./KeyImages/Key-12.png)"
                })
                $("#Key13").appendTo("#row3"), $("#Key13").css({
                    "background-image": "url(./KeyImages/Key-13.png)"
                })
                $("#Key14").appendTo("#row3"), $("#Key14").css({
                    "background-image": "url(./KeyImages/Key-14.png)"
                })
            });
        });
//--------------------------------------------------------------------------------------------------------//
    function preload(urls) {
        const requests = urls.map(url => fetch(db_url + url)
            .then(r => r.arrayBuffer()) // this time we request as ArrayBuffer
            .then(b => {
              return new Promise((resolve, reject) => {
                  a_ctx.decodeAudioData(b, resolve, reject)
              });
            })
        );
        return Promise.all(requests);
    }
//--------------------------------------------------------------------------------------------------------//
//--------------------------------------------------------------------------------------------------------//
//RECORDING MUSIC
    let isRecordToggled = false;
    var startTime;
    var animationInterval;
    function toggleRecord() {
        if (isRecordToggled) { //if the recording is toggled already then it means it was listening, now stops listening and saves the song
            if (songArray.length != 0){ 
                var promtText = prompt("Please enter the song name:", "Jingle bells"); //asks for the song name
                if (promtText == null || promtText == "") {
                    console.log("User ignored the save")
                } else {
                    if(document.getElementById("Song-"+promtText) == null){ //if there is already a song with that name, ask to rename it
                        saveSong(promtText,songArray,false)
                    }else{
                        var promtText2 = prompt("Warning! a song with that name already exists", "Rename Me!");
                        if (promtText2 == null || promtText2 == "") {
                            console.log("User ignored the save")
                            } else {
                                saveSong(promtText2,songArray,false)
                            }
                    }
                }
            }
            songArray = []
            toggleRecordBtn.style.backgroundColor = "#5a5a5a"
        } else {
            toggleRecordBtn.style.backgroundColor = "#817f7f"
        }
        isRecordToggled = !isRecordToggled
        startTime = new Date().getTime()
    }
    var savedSongsDiv = document.getElementById("savedSongsDiv")
    var savedSongsDivWrapper = document.getElementById("savedSongsDivWrapper")
    document.getElementById("touch").addEventListener("click",function(){
        savedSongsDivWrapper.style.display = "none"
    })
    function toggleSavedSongs(){
        if(savedSongsDivWrapper.style.display != "block"){
            savedSongsDivWrapper.style.display = "block"
        }else{
            savedSongsDivWrapper.style.display = "none"
        }
    }
//--------------------------------------------------------------------------------------------------------//
//this loads the stored songs in local storage and adds them to the recorded songs, the "true" in saveSong() means that it doesn't have to add 
//the song to the favourites because it is already saved
    preLoadSongs = localStorage.getItem("savedSongs")
    if(preLoadSongs != null){
        preLoadSongs = JSON.parse(preLoadSongs)
        for(var i=0;i<preLoadSongs.length;i++){
            saveSong(preLoadSongs[i].name,preLoadSongs[i].songNotes,true)
        }
    }
//--------------------------------------------------------------------------------------------------------//
    function saveSong(songName,song,isPreloading){ //the name of the song, the array containing the key press and time stamp, if it has to be ignored or not for the save option
            var songObj = {
                name: songName,
                songNotes : song
            }
            if(!isPreloading){ //doesnt save if it is preloading
                var songStorage = localStorage.getItem("savedSongs")
            if(songStorage != null){
                songStorage = JSON.parse(songStorage)
                songStorage.push(songObj)
                localStorage.setItem("savedSongs",JSON.stringify(songStorage))
            }else{
                songStorage = [songObj]
                localStorage.setItem("savedSongs",JSON.stringify(songStorage))
            }
            }
            //--------------------------------// Dinamically create the button to play the song
        var songContainer = document.createElement("div")
        var songButton = document.createElement("button")
            songButton.setAttribute("songName",songName)
            songButton.addEventListener("click",function(){
                var storedSongName = this.getAttribute("songName")
                songText = document.getElementById("Song-"+storedSongName)
                playSong(JSON.parse(songText.innerHTML))
            })
            songButton.innerHTML = songName
            songButton.className = "skyButton"
            songButton.style.width = "calc(100% - 80px - 3em)"
            //--------------------------------// This holds the text of the array of the song 
        var songText = document.createElement("div")
            songText.style.display = "none"
            songText.id = "Song-"+songName
            songText.innerHTML = JSON.stringify(song)
            songContainer.appendChild(songButton)
            songContainer.appendChild(songText)
            console.log("song added!")
            savedSongsDiv.appendChild(songContainer)
            //--------------------------------// button to delete the song from the saved and to delete it from the menu
        var smallContainer = document.createElement("div")
            smallContainer.style = "width: 22%"
        var deleteButton = document.createElement("button")
            deleteButton.innerHTML = "❌"
            deleteButton.className = "skyButton"
            deleteButton.style.width = "40px"
            deleteButton.setAttribute("songName",songName)
            deleteButton.addEventListener("click",function(){
                if(confirm("Delete song: "+this.getAttribute("songName")+"?")){
                    this.parentNode.parentNode.removeChild(this.parentNode)
                    var savedSongs = localStorage.getItem("savedSongs")
                    if(savedSongs != null){
                        savedSongs = JSON.parse(savedSongs)
                        for(var i=0;i<savedSongs.length;i++){ //reads trough all the elements of the localStorage and deletes the index of this song
                            if(savedSongs[i].name == this.getAttribute("songName")){
                                savedSongs.splice(i,1)
                                break;
                            }
                        }
                        localStorage.setItem("savedSongs",JSON.stringify(savedSongs))
                    }
                }
            })
        var shareButton = document.createElement("button")
            shareButton.innerHTML = "🡆"
            shareButton.style.color = "lightgreen"
            shareButton.className = "skyButton"
            shareButton.style.width = "40px"
            shareButton.setAttribute("songName",songName)
            shareButton.addEventListener("click",function(){
                var storedSongName = this.getAttribute("songName")
                songText = document.getElementById("Song-"+storedSongName)
                var songObj = {
                name: storedSongName,
                songNotes : JSON.parse(songText.innerHTML)
            }
                var array = []
                array.push(songObj)
                downloadJSON(array,storedSongName+".json")
            })
            songContainer.appendChild(deleteButton)
            songContainer.appendChild(shareButton)
    }
//--------------------------------------------------------------------------------------------------------//
    async function playSong(song){
        console.log(song)
        var delayTime = 0;
        var previousTime = 0;
        usesTouch = false;
        for(var i=0;i<song.length;i++){
            delayTime = song[i].time - previousTime //how much time has to pass from one note to the other
            previousTime = song[i].time //the time from the start of the previous note, to be later calculated to get the delayTime
            await delay(delayTime); 
            document.getElementById(song[i].key).click()
        }
    }
//--------------------------------------------------------------------------------------------------------//
    const delay = ms => new Promise(res => setTimeout(res, ms));
//--------------------------------------------------------------------------------------------------------//
    let songArray = []
    //Each time a button is pressed, if the record is toggled, it adds a timestamp and what button is pressed
    function recordSong(pressedKey) {
        if (isRecordToggled) {
            pressTime = new Date().getTime()
            var keyPressObject = {
                time: pressTime - startTime,
                key: pressedKey
            }
            songArray.push(keyPressObject)
        }
    }
</script>